
@model Store.Models.Cart

<div class="container mt-4">
    <div class="row">
        <!-- Danh sách sản phẩm bên trái -->
        <div class="col-md-8">
            <h3>🛒 Chọn sản phẩm để thanh toán</h3>

            @if (Model == null || !Model.Lines.Any())
            {
                <p>Giỏ hàng trống.</p>
            }
            else
            {
                <table class="table table-hover">
                    <thead class="thead-light">
                        <tr>
                            <th></th>
                            <th>Sản phẩm</th>
                            <th>Số lượng</th>
                            <th>Giá</th>
                            <th>Tổng</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Model.Lines)
                        {
                            var totalItem = item.ProductPrice * (1 - item.ProductDiscount) * item.Quantity;
                            <tr class="product-row">
                                <td>
                                    <input type="checkbox" class="form-check-input product-check"
                                           data-total="@totalItem" />
                                </td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <img src="/images/@item.ProductImage" alt="@item.ProductName"
                                             class="img-thumbnail me-3" style="width:70px; height:70px; object-fit:cover;">
                                        <div>
                                            <strong>@item.ProductName</strong><br />
                                            <small class="text-muted">Giảm @(item.ProductDiscount * 100)%</small>
                                        </div>
                                    </div>
                                </td>
                                <td class="text-center">@item.Quantity</td>
                                <td class="text-center">@item.ProductPrice.ToString("n0") $</td>
                                <td class="text-end fw-semibold">@totalItem.ToString("n0") $</td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
        </div>

        
        <div class="col-lg-4">
            @if (ViewBag.CouponMessage != null)
            {
                <div class="alert alert-info">@ViewBag.CouponMessage</div>
            }

           
            <form id="couponForm" class="mb-5">
                <div class="input-group">
                    <input type="text" class="form-control p-4" id="couponCode"
                           placeholder="Coupon Code">
                    <div class="input-group-append">
                        <button class="btn btn-primary" type="submit">Apply Coupon</button>
                    </div>
                </div>
            </form>




            <div class="card border-secondary mb-5">
                <div class="card-header bg-secondary border-0">
                    <h4 class="font-weight-semi-bold m-0">Cart Summary</h4>
                </div>
                <div class="card-body">

                    <div id="selectedProducts" class="mb-3"></div>

                    <div class="d-flex justify-content-between mb-3 pt-1">
                        <h6 class="font-weight-medium">Subtotal</h6>
                        <h6 class="font-weight-medium">$<span id="selectedTotal">0</span></h6>
                        
                    </div>
                    <div class="d-flex justify-content-between">
                        <h6 class="font-weight-medium">Shipping</h6>
                        <h6 class="font-weight-medium">$<span id="shippingValue">10</span></h6>
                        
                    </div>
                </div>

                <div class="card-footer border-secondary bg-transparent">
                    
                    <div class="d-flex justify-content-between mt-2">
                        <h5 class="font-weight-bold">Total</h5>
                        <h5 class="font-weight-bold">$<span id="selectedTotalWithShip">0</span></h5>
                    </div>

                    
                    <form asp-action="CheckoutInfo" method="post" id="checkoutForm">
                        <input type="hidden" name="SelectedProductIds" id="selectedIds" />
                        <input type="hidden" name="TotalWithShip" id="totalWithShipInput" />
                        <button type="submit" class="btn btn-success btn-block" disabled id="checkoutBtn">
                            Xác nhận thanh toán
                        </button>
                    </form>
                </div>





            </div>
        </div>
    </div>
</div>
@section Scripts {
    <script>
        let shippingFee = 10; // mặc định
        const checkboxes = document.querySelectorAll('.product-check');
        const totalEl = document.getElementById('selectedTotal');
        const totalWithShipEl = document.getElementById('selectedTotalWithShip');
        const countEl = document.getElementById('selectedCount');
        const checkoutBtn = document.getElementById('checkoutBtn');
        const selectedIdsInput = document.getElementById('selectedIds');
        const shippingValueEl = document.getElementById('shippingValue');
        const selectedProductsDiv = document.getElementById('selectedProducts');


        function updateTotal() {
            let total = 0;
            let count = 0;
            let selectedIds = [];
            let selectedHtml = "";

            checkboxes.forEach((cb, index) => {
                if (cb.checked) {
                    const row = cb.closest('tr');
                    const name = row.querySelector('strong').textContent;
                    const qty = row.querySelector('td.text-center').textContent.trim();
                    const price = row.querySelector('td.text-end').textContent.trim();

                    total += parseFloat(cb.dataset.total);
                    count++;
                    selectedIds.push(index);

                    selectedHtml += `
                        <div class="d-flex justify-content-between border-bottom py-1">
                            <span>${name} × ${qty}</span>
                            <span>${price}</span>
                        </div>`;
                }
            });

            // Cập nhật hiển thị
            const totalEl = document.getElementById('selectedTotal');
            const totalWithShipEl = document.getElementById('selectedTotalWithShip');
            const shippingValueEl = document.getElementById('shippingValue');
            const selectedProductsDiv = document.getElementById('selectedProducts');
            const checkoutBtn = document.getElementById('checkoutBtn');
            const selectedIdsInput = document.getElementById('selectedIds');

            const totalWithShip = total + shippingFee;
            // Gán tổng tiền (đã gồm ship) vào input ẩn để gửi qua form
            document.getElementById('totalWithShipInput').value = totalWithShip;
            totalEl.textContent = total.toLocaleString('en-US');
            totalWithShipEl.textContent = totalWithShip.toLocaleString('en-US');
            shippingValueEl.textContent = shippingFee.toLocaleString('en-US');
            selectedProductsDiv.innerHTML = selectedHtml || "<small class='text-muted'>Chưa chọn sản phẩm nào</small>";

            selectedIdsInput.value = selectedIds.join(',');

            //cập nhật trạng thái nút thanh toán
            checkoutBtn.disabled = count === 0;
        }
        

        // Gọi lại mỗi khi tick checkbox
        checkboxes.forEach(cb => cb.addEventListener('change', updateTotal));

        // Xử lý áp dụng mã coupon (Cách 2)
        const couponForm = document.getElementById('couponForm');
        couponForm.addEventListener('submit', function (e) {
            e.preventDefault();
            const code = document.getElementById('couponCode').value.trim();

            if (code.toLowerCase() === 'zmobile') {
                shippingFee = 0;
                alert("🎉 Áp dụng mã ZMobile thành công! Miễn phí ship 🚚");
            } else {
                shippingFee = 10;
                alert("⚠️ Mã không hợp lệ. Phí ship mặc định $10.");
            }

            // cập nhật lại hiển thị total sau khi đổi coupon
            updateTotal();
        });

    </script>
}

